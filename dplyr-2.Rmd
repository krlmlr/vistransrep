---
title: "dplyr exercises part 2"
author: "Kirill MÃ¼ller"
date: "October 18, 2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(tidyverse)
```

## [Spreading and gathering](spread-gather.html)

1. Use `spread()` to convert `table2` to `table1`. What is the meaning of the `key` and `value` arguments?

1. Use `gather()` to convert `table1` to `table2`. Do you need an extra transformation to make the result fully identical? Can you reuse `key` and `value` from the previous result?

1. Use a bar chart to visualise the data. Which of `table1` or `table2` is more suitable for plotting?

1. Use `gather()` to convert `table4a` and `table4b` to `table2`.

    Hint: Use `bind_rows()` to combine similar tibbles.

1. Create a scatterplot from the `mpg` dataset that shows both highway and city fuel economy against engine displacement with two different colors using only one `geom_point()` call.

1. Find more exercises in Section 12.3.3 of r4ds.


## [Separating and uniting](sep-unite.html)

1. Convert `table3` to `table1` and `table2`.

1. Convert `table2` to `table3`.

1. Use `separate()` to compute departure and arrival hours and minutes in the `flights` dataset.

1. Find more exercises in Section 12.4.3 of r4ds.


## [Keys and mutating joins](joins.html)

1. Do you see a problem in the `presidential` dataset? Can you see how does this affect the following bar plot without actually running the code?

    ```
    presidential %>%
      mutate(term = end - start) %>%
      ggplot() +
      geom_bar(aes(name, term))
    ```

1. How are the `flights`, `carriers`, and `airports` datasets connected? Which are primary, which are foreign keys?

    Hint: Use `count()` to support your hypothesis.

1. Plot a heat map of destination by airline for all flights shorter than 300 miles. Use explicit names for the carriers and the destinations. Does the result change if you use a full join? Do you use `geom_raster()` or `geom_bin2d()`?

    Hint: Use `by = c("dest" = "faa")`.

1. Find more exercises in Section 13.4.6 of r4ds.


## Filtering joins

1. Find the airports that are serviced by at least one flight. Which airports did not have direct connections in 2013?

1. Find more exercises in Section 13.5.1 of r4ds.


## Time trends

1. Create plots for time trends of new HIV, new TB, and new malaria cases for all countries of a high-impact region of your choice. Each panel should show the data for one country.

    Hint: Use the `gfdata` package.

    ```{r echo=FALSE, cache = TRUE}
    library(gfdata)
    all_stats %>% 
      filter(five_regions == "High Impact Asia") %>% 
      ggplot(aes(x = year, y = hiv_new_infections_number)) +
      geom_line() +
      facet_wrap(~country, scales = "free_y")
    
    all_stats %>%
      filter(five_regions == "High Impact Asia") %>%
      ggplot(aes(x = year, y = tb_new_cases_number)) +
      geom_line() +
      facet_wrap(~country, scales = "free_y")
    
    all_stats %>%
      filter(five_regions == "High Impact Asia") %>%
      ggplot(aes(x = year, y = malaria_new_cases_number)) +
      geom_line() +
      facet_wrap(~country, scales = "free_y")
    ```

1. Create a single plot that shows time trends of new HIV, new TB, and new malaria cases for all countries of a high-impact region of your choice. Each panel should show the data for one country and one disease.

    Hint: You need to reorganize your data. Use `rename()` to bring the columns into a consistent format, and a combination of `spread()`, `gather()`, and `separate(..., into = c("disease", "indicator"), extra = "merge")` to extract the disease from the rest of the column name.

    ```{r echo=FALSE, cache = TRUE, fig.height = 8}
    library(gfdata)
    all_stats_new_cases_long <- 
      all_stats %>%
      rename(hiv_new_cases_number = hiv_new_infections_number) %>%
      select(
        five_regions, country, year,
        ends_with("_new_cases_number")
      ) %>% 
      gather(indicator, count, -five_regions, -country, -year) %>% 
      separate(
        indicator,
        into = c("disease", "indicator"),
        extra = "merge"
      ) %>%
      mutate(disease = recode(
        disease,
        "tb" = "TB", "malaria" = "Malaria", "hiv" = "HIV"
      )) %>% 
      mutate(disease = forcats::fct_inorder(disease)) %>% 
      spread(indicator, count)
    
    all_stats_new_cases_long %>% 
      filter(five_regions == "High Impact Asia") %>% 
      ggplot(aes(x = year, y = new_cases_number)) +
      geom_line() +
      facet_grid(country~disease, scales = "free")
    ```

1. Create a single plot that shows aggregated time trends of new HIV, new TB, and new malaria cases for all regions, composed of the sum of all cases from each country in a reagion. Each panel should show the data for one region and one disease. At which stage in the data processing do you implement the aggregation?

    ```{r echo=FALSE, cache = TRUE}
    library(gfdata)
    all_stats_new_cases_long %>% 
      group_by(five_regions, year, disease) %>% 
      summarize(new_cases_number = sum(new_cases_number, na.rm = TRUE)) %>% 
      ungroup %>% 
      ggplot(aes(x = year, y = new_cases_number)) +
      geom_line() +
      facet_grid(five_regions~disease, scales = "free")
    ```

1. Create a single plot that shows time trends of mortality or incidence rates for HIV, TB, and malaria cases for all countries of a high-impact region of your choice. Each panel should show the data for one region and one disease.

    Hint: you need to create the following new variables first. Use a consistent naming scheme.
    - HIV incidence rate = number of new HIV infections `hiv_new_infections_number` divided by uninfected population in the previous year (t-1) `population_excluding_plwha` multiplied by 100
    - HIV mortality rate = number of AIDS deaths `aids_deaths_number` divided by total population `population_all_ages` multiplied by 100
    - TB incidence rate = number of new TB cases `tb_new_cases_number` divided by total population `population_all_ages` multiplied by 100,000
    - TB mortality rate = number of TB deaths `tb_deaths_number` divided by total population `population_all_ages` multiplied by 100,000
    - Malaria incidence rate = number of new malaria cases `malaria_new_cases_number` divided by population at malaria risk `population_at_malaria_risk` multiplied by 1000
    - Malaria mortality rate = number of malaria deaths `malaria_deaths_number` divided by population at malaria risk `population_at_malaria_risk` multiplied by 1000


    ```{r echo=FALSE, cache = TRUE, fig.height = 8}
    library(gfdata)
    all_stats_inc_mort_long <-
      all_stats %>%
      rename(hiv_new_cases_number = hiv_new_infections_number) %>%
      rename(hiv_deaths_number = aids_deaths_number) %>%
      group_by(five_regions, country) %>%
      mutate(
        hiv_incidence = hiv_new_cases_number / lag(population_excluding_plwha) * 100,
        hiv_mortality = hiv_deaths_number / population_all_ages * 100,
        tb_incidence = tb_new_cases_number / population_all_ages * 100000,
        tb_mortality = tb_deaths_number / population_all_ages * 100000,
        malaria_incidence = malaria_new_cases_number / population_at_malaria_risk * 1000,
        malaria_mortality = malaria_deaths_number / population_at_malaria_risk * 1000
      ) %>%
      select(
        five_regions, country, year,
        ends_with("_incidence"),
        ends_with("_mortality")
      ) %>%
      gather(indicator, count, -five_regions, -country, -year) %>%
      separate(
        indicator,
        into = c("disease", "indicator"),
        extra = "merge"
      ) %>%
      mutate(disease = recode(
        disease,
        "tb" = "TB", "malaria" = "Malaria", "hiv" = "HIV"
      )) %>%
      mutate(disease = forcats::fct_inorder(disease)) %>%
      spread(indicator, count)
    ```

    ```{r echo=FALSE, cache = TRUE}
    library(gfdata)
    all_stats_inc_mort_long %>% 
      filter(five_regions == "High Impact Asia") %>% 
      ggplot(aes(x = year, y = mortality)) +
      geom_line() +
      facet_grid(country~disease, scales = "free")
    ```

1. Create a single plot that shows aggregated time trends of mortality or incidence rates for HIV, TB, and malaria cases for all regions. Each panel should show the data for one region and one disease.

    Hint: You need to sum the numerators across relevant countries and divide it by sum of the denominators across the same set of countries.



1. Create a single plot that shows time trends of mortality or incidence rates for HIV, TB, and malaria cases for all countries in all high-impact regions, compared against the year 2000 baseline. Each panel should show the data for one region.

    Hint: Use `first()` with a grouped `mutate()`.

1. Create a single plot that shows time trends of the number of people living with HIV/AIDS in need for ART (`people_living_with_hiv_aids_number` and the corresponding `upper` and `lower` uncertainty ranges) for all countries in all high-impact regions. Each panel should show the data for one country.

1. Create a single plot that shows time trends of the number of people living with HIV/AIDS in need for ART aggregated over all countries in a region. Each panel should show the data for one region.

1. Create a stack bar graph with three bars, each bar represents one disease and the indicator should be number of deaths for each disease in 2015. The stacks should be expressed as percent and three categories of eligibility. This shows across Global Fund supported countries for three diseases what share of deaths is not covered in each disease due to not being eligible.

1. Load data from sheets 1 to 9 in the Excel file and bring them into a tidy format.

    Hint: The path to the Excel file on the RStudio server is `"/data/r-course/courswork_data_tgf.xlsx"`. Before reading the file, create a link to the `"/data/r-course"` directory using `file.symlink()`. Use `readxl::read_excel()` and look at the documentation of the `sheet` and `range` arguments to that function. How do you specify column names?


## Case study

1. Use your own data to answer a question about it using the tools you have learned in this course.

    Hint: To import, use the "readr" (CSV), "readxl" (Excel), or "haven" (SPSS/SAS/Stata) packages. Use the internet to find out how to import other kinds of data, use `as_tibble()` right after importing to get consistent printing.

1. Alternatively, create a plot of the total number of tuberculosis cases per year for eight countries of your choice. Can you also plot the share (relative to the overall population of the country)?
