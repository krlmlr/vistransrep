```{r 26-remove-all, include = FALSE}
rm(list = ls())
```


## Create new columns based on old ones: `dplyr::mutate()`

<details><summary>*Click here to show setup code.*</summary>
```{r include = FALSE}
### Create new columns based on old ones: `dplyr::mutate()`

```
```{r 26-setup-26-mutate-r}
library(tidyverse)
library(nycflights13)

library(conflicted)
conflict_prefer("filter", "dplyr")
conflict_prefer("lag", "dplyr")
```
</details>

With `dplyr::mutate()` you can add new columns to a table, e.g. making use of the already existing variables.

How much faster than the scheduled time did the pilots manage to fly:

```{r include = FALSE}
# mutate 1
```
```{r 26-mutate-1}
flights %>%
  mutate(recovery = dep_delay - arr_delay)
```

This is another building block added to the toolset:

```{r include = FALSE}
# mutate select
```
```{r 26-mutate-select}
flights %>%
  mutate(recovery = dep_delay - arr_delay) %>%
  select(dep_delay, arr_delay, recovery)
```

Work with the newly created variable just like with the original ones:

```{r include = FALSE}
# mutate select arrange
```
```{r 26-mutate-select-arrange}
flights %>%
  mutate(recovery = dep_delay - arr_delay) %>%
  select(dep_delay, arr_delay, recovery) %>%
  arrange(recovery)
```

Assign the results to new variables.
The old ones remain unchanged.

```{r include = FALSE}
# assign mutate select arrange
```
```{r 26-assign-mutate-select-arrange}
recovery_data <-
  flights %>%
  mutate(recovery = dep_delay - arr_delay) %>%
  select(dep_delay, arr_delay, recovery) %>%
  arrange(recovery)

recovery_data
```

Reduce a dataset to just the first `n` (default is 6) lines with `utils::head()`:

```{r include = FALSE}
# flights head view
```
```{r 26-flights-head-view}
flights %>%
  head() %>%
  view()
```

Let's look at a single airplane:

```{r include = FALSE}
# flights filter select view
```
```{r 26-flights-filter-select-view}
flights %>%
  filter(tailnum == "N14228") %>%
  select(year, month, day, dep_time, arr_time) %>%
  view()
```

Adding the departure time of the NEXT flight to the current row, respectively, using `mutate()` with `dplyr::lead()`:

```{r include = FALSE}
# flights filter select mutate lead view
```
```{r 26-flights-filter-select-mutate-lead-view}
flights %>%
  filter(tailnum == "N14228") %>%
  select(year, month, day, dep_time, arr_time) %>%
  mutate(lead_dep_time = lead(dep_time)) %>%
  view()
```

The opposite effect to `lead()` can be realized using `lag()`:

```{r include = FALSE}
# flights filter select mutate lag view
```
```{r 26-flights-filter-select-mutate-lag-view}
flights %>%
  filter(tailnum == "N14228") %>%
  select(year, month, day, dep_time, arr_time) %>%
  mutate(lag_arr_time = lag(arr_time)) %>%
  view()
```

There is even a use-case for this in our little example.
How long did our airplane stay on the ground before each of its flights?

```{r include = FALSE}
# flights filter select mutate lag mutate ground time view
```
```{r 26-flights-filter-select-mutate-lag-mutate-ground-time-view}
flights %>%
  filter(tailnum == "N14228") %>%
  select(year, month, day, dep_time, arr_time) %>%
  mutate(lag_arr_time = lag(arr_time)) %>%
  mutate(ground_time = dep_time - lag_arr_time) %>%
  view()
```

The negative values occur because not everything happens on the same day, implying that our method is still in need of some refinement.
Nevertheless, let's continue.

A frequently used workflow is creating a helper variable at some point in the pipeline and then dropping it later on:

```{r include = FALSE}
# deselect with minus
```
```{r 26-deselect-with-minus}
flights %>%
  filter(tailnum == "N14228") %>%
  select(year, month, day, dep_time, arr_time) %>%
  mutate(lag_arr_time = lag(arr_time)) %>%
  mutate(ground_time = dep_time - lag_arr_time) %>%
  select(-lag_arr_time)
```

Let's work some more with the flight data of our special plane.

```{r include = FALSE}
# flights filter view
```
```{r 26-flights-filter-view}
flights %>%
  filter(tailnum == "N14228") %>%
  view()
```

The total air time of the plane up to and including a given flight can be calculated with `base::cumsum()`:

```{r include = FALSE}
# air time N14228
```
```{r 26-air-time-n-14228}
flights %>%
  filter(tailnum == "N14228") %>%
  mutate(cum_air_time = cumsum(air_time)) %>%
  select(air_time, cum_air_time) %>%
  view()
```

Creating a "flag" variable with `mutate()` which shows if a flight was on time or not:

```{r include = FALSE}
# delayed flag N14228
```
```{r 26-delayed-flag-n-14228}
flights %>%
  filter(tailnum == "N14228") %>%
  mutate(delayed = if_else(arr_delay > 0, "delayed", "on time")) %>%
  select(arr_delay, delayed)
```

A more straightforward way to get the same (or at least a very similar and probably easier to work with) result:

```{r include = FALSE}
# delayed flag 2 N14228
```
```{r 26-delayed-flag-2-n-14228}
flights %>%
  filter(tailnum == "N14228") %>%
  mutate(delayed = arr_delay > 0) %>%
  select(arr_delay, delayed)
```

... easier to work with, because `filter()` can directly take logical arguments:

```{r include = FALSE}
# filter by flag
```
```{r 26-filter-by-flag}
flights %>%
  filter(tailnum == "N14228") %>%
  mutate(delayed = arr_delay > 0) %>%
  select(arr_delay, delayed) %>%
  filter(delayed)
```

Negation for inverse filtering:

```{r include = FALSE}
# filter by flag inverse
```
```{r 26-filter-by-flag-inverse}
flights %>%
  filter(tailnum == "N14228") %>%
  mutate(delayed = arr_delay > 0) %>%
  select(arr_delay, delayed) %>%
  filter(!delayed)
```

These are the flights that had no delay:

```{r include = FALSE}
# on time flights
```
```{r 26-on-time-flights}
on_time_flights <-
  flights %>%
  filter(tailnum == "N14228") %>%
  mutate(delayed = arr_delay > 0) %>%
  select(arr_delay, delayed) %>%
  filter(!delayed)
```
