<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />


<meta name="author" content="Kirill Müller, cynkra GmbH" />

<meta name="date" content="2017-06-02" />

<title>Joins</title>

<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="site_libs/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>

<link rel="stylesheet" href="styles.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
  height: auto;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">R + tidyverse</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="index.html">Home</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Setup
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="intro.html">intro</a>
    </li>
    <li>
      <a href="rstudio.html">rstudio</a>
    </li>
    <li>
      <a href="outro.html">outro</a>
    </li>
    <li>
      <a href="support.html">support</a>
    </li>
  </ul>
</li>
<li>
  <a href="ggplot2.html">ggplot2</a>
</li>
<li>
  <a href="dplyr.html">dplyr</a>
</li>
<li>
  <a href="tidyr.html">tidyr</a>
</li>
<li>
  <a href="import.html">import</a>
</li>
<li>
  <a href="rmarkdown.html">rmarkdown</a>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Joins</h1>
<h4 class="author">Kirill Müller, cynkra GmbH</h4>
<h4 class="date">June 2, 2017</h4>

</div>


<div id="counting-distinct-observations" class="section level2">
<h2>Counting distinct observations</h2>
<p>Which columns in the <code>airlines</code> and <code>airports</code> tables uniquely identify the observations, i.e., are keys in these tables? Verify. How are these tables connected to the <code>flights</code> table?</p>
<p>```r airlines %&gt;% count(___) %&gt;% filter(n &gt; 1)</p>
<p>airports %&gt;% _____ %&gt;% _____</p>
<p>airlines %&gt;% inner_join(___)</p>
<p>airlines %&gt;% inner_join(___, by = c(“<strong><em>&quot; = &quot;</em></strong>”)) ``</p>
<details>
<p><summary>► Solution:</summary></p>
<pre class="r"><code>airlines %&gt;%
  count(carrier) %&gt;% 
  filter(n &gt; 1)</code></pre>
<pre><code>## # A tibble: 0 x 2
## # … with 2 variables: carrier &lt;chr&gt;, n &lt;int&gt;</code></pre>
<pre class="r"><code>airports %&gt;%
  count(faa) %&gt;%
  filter(n &gt; 1)</code></pre>
<pre><code>## # A tibble: 0 x 2
## # … with 2 variables: faa &lt;chr&gt;, n &lt;int&gt;</code></pre>
<pre class="r"><code>airlines %&gt;%
  inner_join(flights)</code></pre>
<pre><code>## Joining, by = &quot;carrier&quot;</code></pre>
<pre><code>## # A tibble: 336,776 x 20
##    carrier name   year month   day dep_time sched_dep_time dep_delay
##    &lt;chr&gt;   &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;
##  1 9E      Ende…  2013     1     1      810            810         0
##  2 9E      Ende…  2013     1     1     1451           1500        -9
##  3 9E      Ende…  2013     1     1     1452           1455        -3
##  4 9E      Ende…  2013     1     1     1454           1500        -6
##  5 9E      Ende…  2013     1     1     1507           1515        -8
##  6 9E      Ende…  2013     1     1     1530           1530         0
##  7 9E      Ende…  2013     1     1     1546           1540         6
##  8 9E      Ende…  2013     1     1     1550           1550         0
##  9 9E      Ende…  2013     1     1     1552           1600        -8
## 10 9E      Ende…  2013     1     1     1554           1600        -6
## # … with 336,766 more rows, and 12 more variables: arr_time &lt;int&gt;,
## #   sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
<pre class="r"><code>airports %&gt;%
  inner_join(flights, by = c(&quot;faa&quot; = &quot;dest&quot;))</code></pre>
<pre><code>## # A tibble: 329,174 x 26
##    faa   name    lat   lon   alt    tz dst   tzone  year month   day
##    &lt;chr&gt; &lt;chr&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;int&gt; &lt;dbl&gt; &lt;chr&gt; &lt;chr&gt; &lt;int&gt; &lt;int&gt; &lt;int&gt;
##  1 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     1
##  2 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     2
##  3 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     3
##  4 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     4
##  5 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     5
##  6 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     6
##  7 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     7
##  8 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     8
##  9 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10     9
## 10 ABQ   Albu…  35.0 -107.  5355    -7 A     Amer…  2013    10    10
## # … with 329,164 more rows, and 15 more variables: dep_time &lt;int&gt;,
## #   sched_dep_time &lt;int&gt;, dep_delay &lt;dbl&gt;, arr_time &lt;int&gt;,
## #   sched_arr_time &lt;int&gt;, arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;,
## #   tailnum &lt;chr&gt;, origin &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;,
## #   hour &lt;dbl&gt;, minute &lt;dbl&gt;, time_hour &lt;dttm&gt;</code></pre>
</details>
</div>
<div id="destination-by-airline" class="section level2">
<h2>Destination by airline</h2>
<p>Compute a list of all flights shorter than 300 miles. Use explicit names for the carriers and the destinations. How do you turn off the joining messages? Describe the column names in the result.</p>
<p>Hint: Use <code>by = c(&quot;dest&quot; = &quot;faa&quot;)</code>.</p>
<pre class="r"><code>flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  count(dest, carrier) %&gt;%
  left_join(airlines, _____) %&gt;%
  left_join(airports, by = c(&quot;___&quot; = &quot;___&quot;))</code></pre>
<details>
<p><summary>► Solution:</summary></p>
<pre class="r"><code>flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  left_join(airlines, by = &quot;carrier&quot;) %&gt;%
  left_join(airports, by = c(&quot;dest&quot; = &quot;faa&quot;))</code></pre>
<pre><code>## # A tibble: 51,287 x 27
##     year month   day dep_time sched_dep_time dep_delay arr_time
##    &lt;int&gt; &lt;int&gt; &lt;int&gt;    &lt;int&gt;          &lt;int&gt;     &lt;dbl&gt;    &lt;int&gt;
##  1  2013     1     1      557            600        -3      709
##  2  2013     1     1      559            559         0      702
##  3  2013     1     1      629            630        -1      721
##  4  2013     1     1      632            608        24      740
##  5  2013     1     1      639            640        -1      739
##  6  2013     1     1      732            735        -3      857
##  7  2013     1     1      733            736        -3      854
##  8  2013     1     1      801            805        -4      900
##  9  2013     1     1      803            810        -7      903
## 10  2013     1     1      820            830       -10      940
## # … with 51,277 more rows, and 20 more variables: sched_arr_time &lt;int&gt;,
## #   arr_delay &lt;dbl&gt;, carrier &lt;chr&gt;, flight &lt;int&gt;, tailnum &lt;chr&gt;,
## #   origin &lt;chr&gt;, dest &lt;chr&gt;, air_time &lt;dbl&gt;, distance &lt;dbl&gt;, hour &lt;dbl&gt;,
## #   minute &lt;dbl&gt;, time_hour &lt;dttm&gt;, name.x &lt;chr&gt;, name.y &lt;chr&gt;, lat &lt;dbl&gt;,
## #   lon &lt;dbl&gt;, alt &lt;int&gt;, tz &lt;dbl&gt;, dst &lt;chr&gt;, tzone &lt;chr&gt;</code></pre>
</details>
</div>
<div id="destination-by-airline-wide-form" class="section level2">
<h2>Destination by airline, wide form</h2>
<p>Count the number of observations per airline per destination, and convert to wide form using nice labels for better use of screen space. Do you use <code>spread()</code> or <code>gather()</code>? How do you replace the <code>NA</code> values with zeros?</p>
<pre class="r"><code># The name of the `name` variable isn&#39;t very useful,
# need to rename it
flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  left_join(_____) %&gt;%
  rename(carrier_name = ___) %&gt;%
  left_join(_____) %&gt;%
  rename(_____) %&gt;%
  count(_____) %&gt;%
  _____(_____)</code></pre>
<details>
<p><summary>► Solution:</summary></p>
<pre class="r"><code>flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  left_join(airlines, by = &quot;carrier&quot;) %&gt;%
  rename(carrier_name = name) %&gt;%
  left_join(airports, by = c(&quot;dest&quot; = &quot;faa&quot;)) %&gt;% 
  rename(airport_name = name) %&gt;%
  count(carrier_name, airport_name) %&gt;%
  spread(carrier_name, n)</code></pre>
<pre><code>## # A tibble: 19 x 12
##    airport_name `American Airli… `Delta Air Line… `Endeavor Air I…
##    &lt;chr&gt;                   &lt;int&gt;            &lt;int&gt;            &lt;int&gt;
##  1 Albany Intl                NA               NA               NA
##  2 Baltimore W…               NA               NA              856
##  3 Bradley Intl               NA               NA               NA
##  4 Buffalo Nia…               NA                3               54
##  5 Burlington …               NA               NA                2
##  6 General Edw…             1455              972              914
##  7 Greater Roc…               NA               NA              281
##  8 La Guardia                 NA               NA               NA
##  9 Manchester …               NA               NA               11
## 10 &quot;Martha\\\\…               NA               NA               71
## 11 Nantucket M…               NA               NA               NA
## 12 Norfolk Intl               NA               NA              402
## 13 Philadelphi…               NA                2              940
## 14 Portland In…               NA              235               NA
## 15 Richmond In…               NA               NA              340
## 16 Ronald Reag…               NA                2             1074
## 17 Syracuse Ha…               NA               NA              170
## 18 Theodore Fr…               NA               NA               NA
## 19 Washington …               NA               NA              664
## # … with 8 more variables: `Envoy Air` &lt;int&gt;, `ExpressJet Airlines
## #   Inc.` &lt;int&gt;, `JetBlue Airways` &lt;int&gt;, `Mesa Airlines Inc.` &lt;int&gt;,
## #   `SkyWest Airlines Inc.` &lt;int&gt;, `Southwest Airlines Co.` &lt;int&gt;, `United
## #   Air Lines Inc.` &lt;int&gt;, `US Airways Inc.` &lt;int&gt;</code></pre>
</details>
</div>
<div id="destination-by-airline-economic-join" class="section level2">
<h2>Destination by airline, economic join</h2>
<p>Change the code from the last example to use <code>count()</code> right after <code>filter()</code>. What additional steps do you need?</p>
<pre class="r"><code>airline_names &lt;-
  airlines %&gt;%
  _____()

dest_airport_names &lt;-
  _____ %&gt;%
  _____()

flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  count(_____) %&gt;% 
  left_join(_____, by = &quot;___&quot;) %&gt;%
  select(-___) %&gt;% 
  left_join(_____, by = &quot;___&quot;) %&gt;% 
  _____(_____)</code></pre>
<details>
<p><summary>► Solution:</summary></p>
<pre class="r"><code>airline_names &lt;-
  airlines %&gt;%
  rename(carrier_name = name)

dest_airport_names &lt;-
  airports %&gt;%
  select(dest = faa, airport_name = name)

verbose_destinations_by_carrier &lt;-
  flights %&gt;% 
  filter(distance &lt; 300) %&gt;%
  count(carrier, dest) %&gt;% 
  left_join(airline_names, by = &quot;carrier&quot;) %&gt;%
  select(-carrier) %&gt;% 
  left_join(dest_airport_names, by = &quot;dest&quot;) %&gt;% 
  select(-dest)

verbose_destinations_by_carrier</code></pre>
<pre><code>## # A tibble: 58 x 3
##        n carrier_name      airport_name                      
##    &lt;int&gt; &lt;chr&gt;             &lt;chr&gt;                             
##  1   914 Endeavor Air Inc. General Edward Lawrence Logan Intl
##  2     2 Endeavor Air Inc. Burlington Intl                   
##  3    54 Endeavor Air Inc. Buffalo Niagara Intl              
##  4   856 Endeavor Air Inc. Baltimore Washington Intl         
##  5  1074 Endeavor Air Inc. Ronald Reagan Washington Natl     
##  6   664 Endeavor Air Inc. Washington Dulles Intl            
##  7    11 Endeavor Air Inc. Manchester Regional Airport       
##  8    71 Endeavor Air Inc. &quot;Martha\\\\&#39;s Vineyard&quot;           
##  9   402 Endeavor Air Inc. Norfolk Intl                      
## 10   940 Endeavor Air Inc. Philadelphia Intl                 
## # … with 48 more rows</code></pre>
</details>
</div>
<div id="heat-map" class="section level2">
<h2>Heat map</h2>
<p>Plot a heat map of destination by airline for all flights shorter than 300 miles, with explicit names. Do you use <code>geom_raster()</code> or <code>geom_bin2d()</code>?</p>
<p>Hint: Use <code>by = c(&quot;dest&quot; = &quot;faa&quot;)</code>.</p>
<pre class="r"><code>verbose_destinations_by_carrier &lt;-
  _____

verbose_destinations_by_carrier %&gt;% 
  ggplot() +
  geom____(aes(___))</code></pre>
<details>
<p><summary>► Solution:</summary></p>
<pre class="r"><code>verbose_destinations_by_carrier %&gt;%
  ggplot() +
  geom_raster(aes(airport_name, carrier_name, fill = n)) +
  ggpubr::rotate_x_text()</code></pre>
<p><img src="joins_files/figure-html/joins-6-1.png" width="672" /></p>
<pre class="r"><code>  # theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))</code></pre>
</details>
</div>
<div id="more-exercises" class="section level2">
<h2>More exercises</h2>
<p>Find more exercises in Section 13.4.6 of r4ds.</p>
</div>

<p>Copyright &copy; 2018 Kirill Müller. Licensed under <a href="https://creativecommons.org/licenses/by-nc/4.0/">CC BY-NC 4.0</a>.</p>



</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.header').parent('thead').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
